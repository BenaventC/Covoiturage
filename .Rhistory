knitr::opts_chunk$set(echo = TRUE,include=TRUE, echo=TRUE, message=FALSE, warning=FALSE)
library(readr)
library(tidyverse)
library(reshape2)
library(gridExtra)
library(lme4)
library(jtools)
library(interactions)
df <- read_delim("covoit.csv", ";", escape_double = FALSE, trim_ws = TRUE)
df<- df%>% rename(TauxOccup=`Places Restantes`,
Depart=`Ville Depart Capture`,
Arrivee=`Ville Arrivee Capture`,
Flex=`Flexibilite Horaire`
)
df<-df %>% filter( Distance<1000)
#on recode les places restantes par une approximation du taux de réservation
df$Occup<- NA
df$Occup[df$TauxOccup==0]<-1
df$Occup[df$TauxOccup==1]<-.75
df$Occup[df$TauxOccup==2]<-.50
df$Occup[df$TauxOccup==3]<-.25
df$Occup[df$TauxOccup==4]<-0
df$Occup[df$TauxOccup>=4]<-0
#l'expérience peut se capter par le nombre de voyages
df$Nombre[is.na(df$Nombre)]<-0
trajet<-table(df$Depart, df$Arrivee)
df$trajet<-paste0(df$Depart,"-",df$Arrivee)
foo<-df %>% mutate(n=1)%>%group_by(trajet)%>%summarise(n=sum(n))%>%filter(n>0)
ggplot(foo,aes(x=reorder(trajet,n), y=n))+geom_bar(stat="identity", fill="coral1")+coord_flip()+theme_bw()+labs(title="Trajets les plus fréquents")
ggplot(df, aes(x=Distance))+geom_histogram(fill="Chartreuse4",binwidth = 20)+theme_bw() +labs(title = "Distribution de la distance des trajets")
# ggplot(df, aes(x=Marque))+geom_bar(fill="Chartreuse4")+theme_bw() +coord_flip()
g2<-ggplot(df, aes(x=Age))+geom_histogram(fill="Chartreuse4")+theme_bw() +scale_x_log10() +labs(title="Distribution de l'âge")
df$Age2<-(round(df$Age/10,0))
foo<-df %>% group_by(Age2)%>%summarise(Note=mean(Note, na.rm=TRUE)) %>% filter(Age2<9)
g3<-ggplot(foo, aes(x=Age2, y=Note, group=1))+geom_line(stat="identity",color="Chartreuse4",size =2)+theme_bw()+labs(title="Note en fonction de l'âge")
grid.arrange(g2,g3,ncol=2)
fit<-lm(Note~Age2, df)
anova(fit)
df$Flex[df$Flex!="Depart pile a l'heure" & df$Flex!="Pas d'indication"]<-"Voir avec le conducteur"
df$Flex[is.na(df$Flex)]<-"Pas d'indication"
ggplot(df, aes(x=Flex))+geom_bar(fill="Chartreuse4")+theme_bw() +coord_flip()+labs(title="Flexibilité de l'horaire")
df$Detour[df$Detour=="De 30 minutes max"]<-"Plus de 15 mn"
df$Detour[df$Detour=="Autant que possible"]<-"Plus de 15 mn"
ggplot(df, aes(x=Detour))+geom_bar(fill="Chartreuse4")+theme_bw()  +coord_flip()+labs(title="Acceptation des détours")
df$Statut<-as.factor(df$Statut)
ggplot(df, aes(x=Statut))+
geom_bar(fill="Chartreuse4")+theme_bw() +
coord_flip()+
labs(title = "Statuts de conducteur")
foo<-df %>% group_by(Statut)%>%summarise(Note=mean(Note,na.rm=TRUE),Nombre=mean(Nombre,na.rm=TRUE))
foo<-melt(foo)
ggplot(foo, aes(x=Statut, y=value,group=variable))+geom_line(aes(color=variable), size=2)+
theme_bw() +
coord_flip()+facet_wrap(vars(variable),scales ="free")+  labs(title = "Profil des  statuts de conducteur")+scale_color_manual(values=c("coral1", "skyblue3"))+ guides(color = FALSE, size = FALSE)
mean<-round(mean(df$Note,na.rm=TRUE),2)
ggplot(df, aes(x=Note))+geom_histogram(fill="coral2",binwidth = .1)+
theme_bw() +
labs(title = "Distribution des notes des conducteurs", subtitle =paste0("Moyenne=", mean))
mean<-round(mean(df$Nombre,na.rm=TRUE),2)
ggplot(df, aes(x=Nombre))+geom_histogram(fill="skyblue1", binwidth = 5)+theme_bw()+labs(title = "Distribution du nombre de trajets réalisés", subtitle =paste0("Moyenne=", mean))+xlim(0,300)
ggplot(df, aes(x=Nombre, y=Note))+geom_point(color="Chartreuse3",alpha=0.3)+theme_bw() +geom_smooth()+xlim(0,500)+labs(title="Corrélation nombre de trajets et note moyenne du conducteur")
ggplot(df, aes(x=Occup))+geom_bar(fill="gold2")+theme_bw()  +labs(title="Distribution des taux d'occupation")
fit0<-lm(Occup~Age+Distance+Prix+Flex+Detour+Autoroute+Statut+log(Nombre+1)+Note, data=df)
summ(fit0)
fit1<-lm(Occup~Age+Statut+Distance+Prix+Autoroute+log(Nombre+1)+Note:log(Nombre+1), data=df)
summ(fit1)
plot_summs(fit0,fit1, plot.distributions = TRUE,scale = FALSE)
g10<-effect_plot(fit1, pred=Age,interval = TRUE ,data=df)+geom_line(color="gold3",size=2)+labs(title="Effet de l'âge sur le taux d'occupation")
g11<-effect_plot(fit1, pred=Statut,interval = TRUE ,data=df)+geom_line(color="gold3",size=2)+labs(title="Effet de l'âge sur le taux d'occupation")
g12<-effect_plot(fit1, pred=Autoroute,interval = TRUE  ,data=df)+geom_line(color="gold3",size=2)+labs(title="Effet de l'autoroute sur le taux d'occupation")
g13<-effect_plot(fit1, pred=Distance,interval = TRUE  ,data=df)+geom_line(color="gold3",size=2)+labs(title="Effet de la distance sur le taux d'occupation")
grid.arrange(g10,g11,g12,g13,ncol=2)
g14<-effect_plot(fit1, pred=Note,interval = TRUE ,data=df)+geom_line(color="gold3",size=2)+labs(title="Effet de la note sur le taux d'occupation")
g15<-effect_plot(fit1, pred=Nombre,interval = TRUE  ,data=df)+geom_line(color="gold3",size=2)+labs(title="Effet du nombre de trajets sur le taux d'occupation")
grid.arrange(g14,g15,ncol=2)
library(interactions)
interact_plot(fit1,pred =Nombre , modx =Note ,interval = TRUE ,data=df) +scale_x_log10()+geom_line(color="gold3",size=2)+labs(title="Interaction Note X Nombre")
fit2<-glmer(Occup~Age+Statut+Distance+Prix+Autoroute+log(Nombre+1)+Note:log(Nombre+1)+(1|trajet),family = binomial, data=df)
summ(fit2)
g16a<-effect_plot(fit2, pred=Age,interval = TRUE  ,data=df)+geom_line(color="gold3",size=2)+labs(title="Effet de l'âge du conducteur",y="taux d'occupation" )
g16b<-effect_plot(fit2, pred=Statut,interval = TRUE  ,data=df)+geom_line(color="gold3",size=2)+labs(title="Effet du statut du conducteur",y="taux d'occupation")
g16<-effect_plot(fit2, pred=Prix,interval = TRUE  ,data=df)+geom_line(color="gold3",size=2)+labs(title="Effet du prix",y="taux d'occupation")
g17<-effect_plot(fit2, pred=Distance,interval = TRUE  ,data=df)+geom_line(color="gold3",size=2)+labs(title="Effet de la distance du trajet",y="taux d'occupation")
grid.arrange(g16a,g16b,g16,g17,ncol=2)
g18<-effect_plot(fit2, pred=Note,interval = TRUE  ,data=df)+geom_line(color="gold3",size=2)+labs(title="Effet de la note",y="taux d'occupation")
g19<-effect_plot(fit2, pred=Nombre,interval = TRUE ,data=df)+geom_line(color="gold3", size=2)+labs(title="Effet du nombre de trajets",y="taux d'occupation")
grid.arrange(g18,g19,ncol=2)
g20<-interact_plot(fit2,pred =Nombre , modx =Note ,interval = TRUE ,data=df) +scale_x_log10()+geom_line(color="gold3", size=2)+labs(title="Effets d'interaction Nombre X Note",y="taux d'occupation")
g20
g20<-ggplot(df, aes(x=Prix))+geom_bar(fill="firebrick2")+theme_bw()  +labs(title = "Distribution des prix")
g21<-ggplot(df, aes(x=Distance, y=Prix))+geom_point(color="firebrick2", alpha =0.5)+theme_bw() +geom_smooth(method="gam")+scale_x_log10()+labs(title = "Corrélation des distances et des prix")
library(gridExtra)
grid.arrange(g20,g21, ncol=2)
df$prix_km<-df$Prix/df$Distance
g22<-ggplot(df, aes(x=prix_km))+geom_histogram(fill="firebrick3", binwidth = 0.005)+theme_bw()  +labs(title = "Distribution des prix")+xlim(0,0.15)
g23<-ggplot(df, aes(x=Distance, y=prix_km))+geom_point(color="firebrick3")+theme_bw() +geom_smooth(method="gam")+scale_x_log10()+ylim(0,0.15)
grid.arrange(g22,g23, ncol=2)
fit3<-lm(prix_km~Age+Distance+Autoroute+log(Nombre+1)+Note, data=df)
summ(fit3)
plot_summs(fit3,  plot.distributions = TRUE,scale = FALSE)
g24<-effect_plot(fit3, pred=Age,interval = TRUE ,data=df)+geom_line(color="firebrick",size=2)+labs(title="Effet de l'âge sur le prix")
g25<-effect_plot(fit3, pred=Distance,interval = TRUE ,data=df)+geom_line(color="firebrick",size=2)+labs(title="Effet de la distance sur le prix")
g27<-effect_plot(fit3, pred=Autoroute,interval = TRUE ,data=df)+geom_line(color="firebrick",size=2)+labs(title="Effet de l'autoroute sur le prix")
g26<-effect_plot(fit3, pred=Note,interval = TRUE ,data=df)+geom_line(color="firebrick",size=2)+labs(title="Effet de la note sur le prix")
g28<-effect_plot(fit3, pred=Nombre,interval = TRUE ,data=df)+geom_line(color="firebrick",size=2)+labs(title="Effet du nombre de trajets")
g29<-interact_plot(fit3,pred =Nombre , modx =Note ,interval = TRUE ,data=df) +scale_x_log10()+geom_line(color="firebrick",size=2)+labs(title="Interaction nombre X Note")
grid.arrange(g24,g25,g27, ncol=2)
grid.arrange(g26,g28, ncol=2)
g29
fit4<-lmer(prix_km~Distance+Autoroute+Age+Note+log(Nombre+1):Note+(1|trajet), data=df)
summary(fit4)
interact_plot(fit4,pred =Note , modx =Nombre ,interval = TRUE ,data=df) +scale_x_log10()+geom_line(color="firebrick",size=2)+labs(title="Interaction  du nombre X note")
models <- df %>% group_by(Statut) %>% summarise(mod = list(lm(Occup~Age+Distance+Autoroute+Prix+log(Nombre+1)+Note:log(Nombre+1))))
coef5<-as.data.frame(models$mod[[1]]$coefficients)%>%add_rownames()%>%mutate(Statut="Ambassadeur")%>% rename(coef=2)
coef1<-as.data.frame(models$mod[[2]]$coefficients)%>%add_rownames()%>% mutate(Statut="Confirmé")%>% rename(coef=2)
coef2<-as.data.frame(models$mod[[3]]$coefficients)%>%add_rownames()%>%mutate(Statut="Expert")%>% rename(coef=2)
coef3<-as.data.frame(models$mod[[4]]$coefficients)%>%add_rownames()%>%mutate(Statut="Habitué")%>% rename(coef=2)
coef4<-as.data.frame(models$mod[[5]]$coefficients)%>%add_rownames()%>%mutate(Statut="Pas de Statut")%>% rename(coef=2)
coef<-rbind(coef1, coef2, coef3, coef4, coef5) %>% filter(rowname!="(Intercept)")
coef$Statut <- factor(coef$Statut, levels = c("Pas de Statut", "Habitué", "Confirmé", "Expert", "Ambassadeur"))
ggplot(coef, aes(x=Statut,y=coef,group=rowname))+geom_line(aes(color=rowname), size=1.3)+theme_bw()+labs(title="Coefficients des variables par statut",subtitle = "Taux d'occupation du véhicule")
models <- df %>% group_by(Statut) %>% summarise(mod = list(lm(prix_km~Distance+Autoroute+Age+Note+log(Nombre+1):Note)))
coef5<-as.data.frame(models$mod[[1]]$coefficients)%>%add_rownames()%>%mutate(Statut="Ambassadeur")%>% rename(coef=2)
coef1<-as.data.frame(models$mod[[2]]$coefficients)%>%add_rownames()%>% mutate(Statut="Confirmé")%>% rename(coef=2)
coef2<-as.data.frame(models$mod[[3]]$coefficients)%>%add_rownames()%>%mutate(Statut="Expert")%>% rename(coef=2)
coef3<-as.data.frame(models$mod[[4]]$coefficients)%>%add_rownames()%>%mutate(Statut="Habitué")%>% rename(coef=2)
coef4<-as.data.frame(models$mod[[5]]$coefficients)%>%add_rownames()%>%mutate(Statut="Pas de Statut")%>% rename(coef=2)
coef<-rbind(coef1, coef2, coef3, coef4, coef5) %>% filter(rowname!="(Intercept)")
coef$Statut <- factor(coef$Statut, levels = c("Pas de Statut", "Habitué", "Confirmé", "Expert", "Ambassadeur"))
ggplot(coef, aes(x=Statut,y=coef,group=rowname))+geom_line(aes(color=rowname), size=1.3)+theme_bw()+labs(title="Coefficients des variables par statut",subtitle = "Prix au km")
